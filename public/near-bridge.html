<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEAR Verification Bridge (HOT Connect)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@hot-connect/near@0.1.x/dist/index.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/@hot-connect/near@0.1.x/dist/index.umd.js"></script> 
    
    <script src="https://unpkg.com/buffer@6.0.3/index.js"></script> 

    <style>
        /* Ваш встроенный CSS для спиннера и кнопки */
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>Подтверждение владения NEAR</h2>
    <p>Для верификации кошелька необходимо подписать сообщение.</p>
    <div id="loading" class="spinner"></div>
    <div id="content" style="display: none;">
        <p>Аккаунт: <strong id="accountIdText">...</strong></p>
        <button id="connectButton">Подключить и Подписать</button>
    </div>
    <div id="error" style="color: red; display: none;"></div>

    <script>
        const NETWORK_ID = 'testnet';
        const CONTRACT_ID = 'vibeindex.testnet'; 

        function getUrlParams() {
            const params = {};
            new URLSearchParams(window.location.search).forEach((value, key) => {
                params[key] = value;
            });
            return params;
        }

        async function initSelector() {
            try {
                // Проверка доступности HOT Connect
                if (typeof HotConnect === 'undefined' || typeof HotConnect.selector === 'undefined') {
                    // Эта ошибка должна быть устранена, так как CSS загружен
                    throw new Error('HOT Connect SDK не загружен. Проблема с CDN.');
                }

                const { code, account } = getUrlParams();
                if (!code || !account) {
                    document.getElementById('error').innerText = 'Ошибка: Недостаточно параметров (code/account).';
                    document.getElementById('error').style.display = 'block';
                    return;
                }
                
                document.getElementById('accountIdText').innerText = account;

                // 1. Инициализация Selector через HOT Connect
                const selector = await HotConnect.selector.setup({
                    network: NETWORK_ID,
                    debug: true,
                    modules: [], 
                });

                // Используем HotConnect.modal
                const modal = HotConnect.modal.setup(selector, {
                    theme: 'dark',
                    contractId: CONTRACT_ID,
                });
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                document.getElementById('connectButton').onclick = () => signMessage(selector, modal, code, account);

            } catch (err) {
                document.getElementById('error').innerText = 'Ошибка инициализации кошелька: ' + err.message;
                document.getElementById('error').style.display = 'block';
            }
        }
        
        async function signMessage(selector, modal, code, expectedAccount) {
            try {
                const wallet = await selector.wallet();

                // 2. Подключение (если не подключен)
                if (!wallet.isSignedIn()) {
                    modal.show();
                    return; 
                }

                const accounts = await wallet.getAccounts();
                const currentAccount = accounts.find(a => a.accountId === expectedAccount);
                
                if (!currentAccount) {
                     alert(`Пожалуйста, выберите аккаунт ${expectedAccount} в кошельке.`);
                     modal.show();
                     return;
                }

                // 3. Запрос на подпись сообщения
                const signatureResult = await wallet.signMessage({
                    message: code,
                    recipient: currentAccount.accountId,
                    nonce: Buffer.from(Date.now().toString()).toJSON().data, 
                });

                const { signature, accountId } = signatureResult;
                
                // 4. Возврат результата в FlutterFlow
                const callbackUrl = `vibeindex://vibeindex.app/verification-result?signature=${signature}&nearAccountId=${accountId}`;
                
                window.location.href = callbackUrl;
                
            } catch (err) {
                document.getElementById('error').innerText = 'Ошибка подписи: ' + err.message;
                document.getElementById('error').style.display = 'block';
            }
        }

        // Запуск кода после полной загрузки DOM и всех скриптов
        window.onload = initSelector;
    </script>
</body>
</html>